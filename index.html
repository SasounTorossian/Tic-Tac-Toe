<!DOCTYPE html>
 <html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>Etch-a-Sketch</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="styles/style.css">
    </head>
    <body>
        <div class="header">
            <h1 class="projectTitle">Tic-Tac-Toe</h1>
        </div>

        <div class="gameInfo">
            <p></p>
        </div>

        <div class="container" >
        </div>

        <div class="footer">
            <p>A project by Sasoun Torossian. 2020</p>
            <a id="gitLink" href="https://github.com/SasounTorossian">
              <img alt="Github" src="images/Github Logo.png" height="60px"></a>
        </div>

        <script>
            // ===== PLAYER =====
            const Player = (name, mark) => {
                let playerName = name
                let playerMark = mark

                return {
                    playerName,
                    playerMark
                }
            }

            // ===== AI =====
            const AI = (name, mark) => {
                let playerName = name
                let playerMark = mark

                const AiPlay = (gameBoardArray) => {
                    let bestScore = -Infinity
                    let bestMove
                    for(let i = 0; i < gameBoardArray.length; i++) {
                        if(gameBoardArray[i] == "") {
                            gameBoardArray[i] = "O"
                            // let score = minimaxAlphaBeta(gameBoardArray, 3, -Infinity, Infinity, false)
                            let score = minimax(gameBoardArray, 1, false)
                            gameBoardArray[i] = ""
                            if (score > bestScore) {
                                bestScore = score
                                bestMove = i
                            }
                        }
                    }

                    let mark = gameEngine.getCurrentPlayer().playerMark
                    gameBoardArray[bestMove] = playerMark
                    let div = document.querySelector(`[index="${bestMove}"]`);
                    div.innerText = mark
                    gameBoard.checkGameboard()  
                }

                let scores = {
                    "O": 10,
                    "X": -10,
                    "TIE": 0
                }


                const minimaxAlphaBeta = (gameBoardArrayAi, depth, alpha, beta, isMaximising) => {
                    // Pass gameboard to checkGameboardWin()?
                    let result = gameBoard.checkGameboardWin()
                    if (result !== null) {
                        // console.log(`depth: ${depth}, score: ${scores[result]}`)
                        return scores[result]
                    }
                    if (depth == 0) {
                        return 0
                    }
                    
                    // AI's turn
                    if(isMaximising) {
                        let maxScore = -Infinity
                        for(let i = 0; i < gameBoardArrayAi.length; i++) {
                            if(gameBoardArrayAi[i] == "") {
                                gameBoardArrayAi[i] = "O"
                                let score = minimaxAlphaBeta(gameBoardArrayAi, depth - 1, alpha, beta, false)
                                gameBoardArrayAi[i] = ""
                                maxScore = Math.max(score, maxScore)
                                alpha = Math.max(alpha, score)
                                if(beta <= alpha) {
                                    break
                                }
                            }
                        }
                        return maxScore + depth
                    }
                    else {
                        let minScore = Infinity
                        for(let i = 0; i < gameBoardArrayAi.length; i++) {
                            if(gameBoardArrayAi[i] == "") {
                                gameBoardArrayAi[i] = "X"
                                let score = minimaxAlphaBeta(gameBoardArrayAi, depth - 1, alpha, beta, true)
                                gameBoardArrayAi[i] = ""
                                minScore = Math.min(score, minScore)
                                beta = Math.min(beta, score)
                                if(beta <= alpha) {
                                    break
                                }
                            }
                        }
                        return minScore - depth
                    }
                }


                const minimax = (gameBoardArrayAi, depth, isMaximising) => {
                    // Pass gameboard to checkGameboardWin()?
                    let result = gameBoard.checkGameboardWin()
                    if (result !== null) {
                        return scores[result]
                    }
                    if (depth == 0) {
                        return 0
                    }
                    
                    // AI's turn
                    if(isMaximising) {
                        let maxScore = -Infinity
                        for(let i = 0; i < gameBoardArrayAi.length; i++) {
                            if(gameBoardArrayAi[i] == "") {
                                gameBoardArrayAi[i] = "O"
                                // console.log(`MAXI depth: ${depth}, ${gameBoardArrayAi}`)
                                let score = minimax(gameBoardArrayAi, depth - 1, false)
                                gameBoardArrayAi[i] = ""
                                maxScore = Math.max(score, maxScore)
                            }
                        }
                        return maxScore + depth
                    }
                    else {
                        let minScore = Infinity
                        for(let i = 0; i < gameBoardArrayAi.length; i++) {
                            if(gameBoardArrayAi[i] == "") {
                                gameBoardArrayAi[i] = "X"
                                // console.log(`MINI depth: ${depth}, ${gameBoardArrayAi}`)
                                let score = minimax(gameBoardArrayAi, depth - 1, true)
                                gameBoardArrayAi[i] = ""
                                minScore = Math.min(score, minScore)
                            }
                        }
                        return minScore - depth
                    }
                }

                return {
                    playerName,
                    playerMark,
                    AiPlay
                }

            }

            // ===== GAME ENGINE =====
            const gameEngine = (() => {
                let gameInfo = document.getElementsByClassName("gameInfo")[0]
                let gameEnd = false
                let players = []
                let currentPlayer

                const startGame = (player1, player2) => {
                    addPlayers(player1, player2)
                    gameBoard.startGameBoard()
                    gameInfoWrite(`Current player is ${getCurrentPlayer().playerName}`)
                    gameEnd = false
                }

                const addPlayers = (p1, p2) => {
                    players.push(p1)
                    players.push(p2)
                    assignPlayers()
                }

                const assignPlayers = () => currentPlayer = players[0]

                const nextTurn = (gameBoard) => {
                    switchPlayer()
                    gameInfoWrite(`Current player is ${getCurrentPlayer().playerName}`)
                    // AND AI game mode for PvP or PvAI game modes
                    if (currentPlayer == players[1]) currentPlayer.AiPlay(gameBoard)
                }

                const switchPlayer = () => {
                    currentPlayer = (currentPlayer == players[0]) ? players[1] : players[0]
                }

                const winningScenario = () => {
                    gameInfoWrite(`Congrats, ${getCurrentPlayer().playerName} won`)
                    gameEnd = true
                    //RESET CODE HERE
                }

                const tieScenario = () => {
                    gameInfoWrite(`It's a tie.`)
                    gameEnd = true
                    //RESET CODE HERE
                }

                const getPlayers = () => players

                const getCurrentPlayer = () => currentPlayer

                const gameInfoWrite = (string) => gameInfo.innerText = string

                const isGameOver = () => gameEnd

                return {
                    startGame,
                    switchPlayer,
                    getPlayers,
                    getCurrentPlayer,
                    winningScenario,
                    tieScenario,
                    isGameOver,
                    nextTurn
                }

            })()

            // ===== GAME BOARD =====
            const gameBoard = (() => {
                let container = document.getElementsByClassName("container")[0]

                let gameBoardArray = new Array(9).fill("")
                const winningCombos = [["0", "1", "2"],
                                        ["3", "4", "5"],
                                        ["6", "7", "8"],
                                        ["0", "3", "6"],
                                        ["1", "4", "7"],
                                        ["2", "5", "8"],
                                        ["0", "4", "8"],
                                        ["2", "4", "6"]]

                const startGameBoard = () => {
                    renderGameboard()
                }

                const addMark = (e) => {
                    let div = e.target
                    let index = div.getAttribute("index")

                    if(gameEngine.isGameOver()) return
                    if(div.innerText != "") return

                    let mark = gameEngine.getCurrentPlayer().playerMark
                    gameBoardArray[index] = mark
                    div.innerText = mark
                    
                    checkGameboard()           
                }

                const renderGameboard = () => {
                    gameBoardArray.forEach(function(element, index) {
                        let div = document.createElement("div")
                        div.classList.add("tile")
                        div.setAttribute("index", index)
                        div.addEventListener('click', addMark)
                        container.appendChild(div)
                    })
                }

                const checkGameboard = () => {
                    if(checkGameboardWin() == "X" || 
                    checkGameboardWin() == "O") gameEngine.winningScenario()
                    else if(checkGameboardTie(gameBoardArray) == "TIE") gameEngine.tieScenario()
                    else gameEngine.nextTurn(gameBoardArray)
                }

                const checkGameboardWin = () => {
                    let player1Win = winningCombos.some(arr => arr.every(el => gameBoardArray[el] == gameEngine.getPlayers()[0].playerMark))
                    let player2Win = winningCombos.some(arr => arr.every(el => gameBoardArray[el] == gameEngine.getPlayers()[1].playerMark))

                    if (player1Win) return "X"
                    if (player2Win) return "O"
                    if(gameBoardArray.indexOf("") == -1) return "TIE"
                    return null
                }

                const checkGameboardTie = () => {
                    if(gameBoardArray.indexOf("") == -1) return "TIE"
                    return null
                }                

                return {
                    startGameBoard,
                    checkGameboard,
                    checkGameboardWin
                }
                })()

                let player1 = Player("Shrek", "X")
                // let player2 = Player("Your Mother", "O")
                let player2 = AI("HAL9000", "O")
                gameEngine.startGame(player1, player2)

        </script>
    </body>
</html>